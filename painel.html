<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel Administrativo CPM</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root {
    --primary-color: #6366f1;
    --primary-dark: #4f46e5;
    --secondary-color: #f1f5f9;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --text-dark: #0f172a;
    --text-muted: #64748b;
    --border-color: #e2e8f0;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    line-height: 1.6;
  }

  .container {
    max-width: 500px;
    margin: 2rem auto;
    padding: 2.5rem;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: var(--card-shadow-hover);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .admin-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: var(--card-shadow-hover);
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .logo {
    text-align: center;
    margin-bottom: 2rem;
  }

  .logo h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
  }

  .logo p {
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 500;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
  }

  .input-group {
    position: relative;
  }

  .input-group i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 1rem;
  }

  input, select {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 0.95rem;
    font-family: inherit;
    transition: all 0.3s ease;
    background: white;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .btn {
    width: 100%;
    padding: 1rem 1.5rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--primary-color);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: var(--card-shadow-hover);
  }

  .hidden {
    display: none !important;
  }

  .alert {
    padding: 1rem;
    border-radius: 12px;
    margin: 1rem 0;
    font-weight: 500;
  }

  .alert-error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger-color);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .alert-success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-color);
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .grid {
    display: grid;
    gap: 1.5rem;
  }

  .grid-2 {
    grid-template-columns: 1fr 1fr;
  }

  .grid-3 {
    grid-template-columns: 1fr 1fr 1fr;
  }

  .card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
  }

  .card:hover {
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-2px);
  }

  .card-header {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .match-item {
    background: var(--secondary-color);
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    position: relative;
  }

  .match-item:hover {
    transform: translateX(4px);
    box-shadow: var(--card-shadow);
  }

  .match-teams {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .team-name {
    font-weight: 600;
    color: var(--text-dark);
  }

  .match-score {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--primary-color);
  }

  .match-round {
    font-size: 0.8rem;
    color: var(--text-muted);
    text-transform: uppercase;
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  .match-actions {
    position: absolute;
    top: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
  }

  .btn-small {
    padding: 0.5rem;
    width: auto;
    min-width: 2.5rem;
    font-size: 0.8rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--border-color);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    display: block;
  }

  .stat-label {
    color: var(--text-muted);
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 768px) {
    .container, .admin-container {
      margin: 1rem;
      padding: 1.5rem;
    }
    
    .grid-2, .grid-3 {
      grid-template-columns: 1fr;
    }

    .match-teams {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.5rem;
    }
  }
</style>
</head>
<body>

<div class="container fade-in" id="login-container">
  <div class="logo">
    <h1><i class="fas fa-trophy"></i> CPM Admin</h1>
    <p>Painel Administrativo do Campeonato</p>
  </div>

  <div class="form-group">
    <label for="username">Usuário</label>
    <div class="input-group">
      <i class="fas fa-user"></i>
      <input type="text" id="username" placeholder="Digite seu usuário">
    </div>
  </div>

  <div class="form-group">
    <label for="password">Senha</label>
    <div class="input-group">
      <i class="fas fa-lock"></i>
      <input type="password" id="password" placeholder="Digite sua senha">
    </div>
  </div>

  <button class="btn btn-primary" onclick="login()">
    <i class="fas fa-sign-in-alt"></i>
    Entrar no Painel
  </button>

  <div id="login-msg"></div>
</div>

<div class="admin-container hidden fade-in" id="admin-container">
  <div class="logo" style="text-align: left; margin-bottom: 2rem;">
    <h1><i class="fas fa-tachometer-alt"></i> Dashboard CPM</h1>
    <p>Gerencie as partidas do campeonato</p>
  </div>

  <!-- Estatísticas -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card">
      <span class="stat-number" id="total-matches">0</span>
      <div class="stat-label">Total de Partidas</div>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="oitavas-count">0</span>
      <div class="stat-label">Oitavas de Final</div>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="quartas-count">0</span>
      <div class="stat-label">Quartas de Final</div>
    </div>
    <div class="stat-card">
      <span class="stat-number" id="semifinais-count">0</span>
      <div class="stat-label">Semifinais</div>
    </div>
  </div>

  <div class="grid grid-2">
    <!-- Formulário para adicionar partidas -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-plus-circle"></i>
          Nova Partida
        </h2>
      </div>

      <div class="form-group">
        <label for="round">Fase do Campeonato</label>
        <div class="input-group">
          <i class="fas fa-layer-group"></i>
          <select id="round">
            <option value="oitavas">Oitavas de Final</option>
            <option value="quartas">Quartas de Final</option>
            <option value="semifinais">Semifinais</option>
            <option value="final">Final</option>
          </select>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="form-group">
          <label for="teamA">Time A</label>
          <div class="input-group">
            <i class="fas fa-users"></i>
            <input type="text" id="teamA" placeholder="Nome do Time A">
          </div>
        </div>

        <div class="form-group">
          <label for="teamB">Time B</label>
          <div class="input-group">
            <i class="fas fa-users"></i>
            <input type="text" id="teamB" placeholder="Nome do Time B">
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="form-group">
          <label for="logoA">Logo Time A</label>
          <div class="input-group">
            <i class="fas fa-image"></i>
            <input type="text" id="logoA" placeholder="nome_logo.png">
          </div>
        </div>

        <div class="form-group">
          <label for="logoB">Logo Time B</label>
          <div class="input-group">
            <i class="fas fa-image"></i>
            <input type="text" id="logoB" placeholder="nome_logo.png">
          </div>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="form-group">
          <label for="scoreA">Placar Time A</label>
          <div class="input-group">
            <i class="fas fa-hashtag"></i>
            <input type="number" id="scoreA" placeholder="0" min="0">
          </div>
        </div>

        <div class="form-group">
          <label for="scoreB">Placar Time B</label>
          <div class="input-group">
            <i class="fas fa-hashtag"></i>
            <input type="number" id="scoreB" placeholder="0" min="0">
          </div>
        </div>
      </div>

      <button class="btn btn-success" onclick="addMatch()">
        <i class="fas fa-plus"></i>
        Adicionar Partida
      </button>
    </div>

    <!-- Lista de partidas -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-list"></i>
          Partidas Registradas
        </h2>
      </div>

      <div id="matches-list">
        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
          <i class="fas fa-spinner fa-spin fa-2x"></i>
          <p style="margin-top: 1rem;">Carregando partidas...</p>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top: 2rem; text-align: center;">
    <button class="btn btn-danger" onclick="logout()" style="width: auto; padding: 1rem 2rem;">
      <i class="fas fa-sign-out-alt"></i>
      Sair do Painel
    </button>
  </div>
</div>

<script>
// Tenta múltiplas URLs caso uma falhe
const API_ENDPOINTS = [
  "http://localhost:3000",
  "http://127.0.0.1:3000", 
  window.location.protocol + "//" + window.location.hostname + ":3000"
];

let API = API_ENDPOINTS[0];

// Função para testar conectividade
async function testConnection() {
  for (const endpoint of API_ENDPOINTS) {
    try {
      console.log(`Testando conexão com: ${endpoint}`);
      const response = await fetch(endpoint + "/api/matches", { 
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache'
      });
      if (response.ok) {
        API = endpoint;
        console.log(`Conexão estabelecida com: ${API}`);
        return true;
      }
    } catch (error) {
      console.log(`Falha ao conectar com ${endpoint}:`, error.message);
    }
  }
  return false;
}

// Testar conexão quando a página carregar
window.addEventListener('DOMContentLoaded', async () => {
  const connected = await testConnection();
  if (!connected) {
    showAlert("Não foi possível conectar ao servidor. Verifique se o servidor está rodando na porta 3000.");
  }
});

function showAlert(message, type = 'error') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = message;
  
  const container = document.querySelector('.container:not(.hidden), .admin-container:not(.hidden)');
  container.insertBefore(alertDiv, container.firstChild);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

function showAlert(message, type = 'error') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = message;
  
  const container = document.querySelector('.container:not(.hidden), .admin-container:not(.hidden)');
  container.insertBefore(alertDiv, container.firstChild);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!username || !password) {
    showAlert("Por favor, preencha todos os campos.");
    return;
  }

  const btn = document.querySelector('#login-container .btn');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<div class="loading"></div> Entrando...';
  btn.disabled = true;

  console.log('Tentando fazer login...', { username, serverUrl: API + "/login" });

  fetch(API + "/login", {
    method: "POST",
    headers: { 
      "Content-Type": "application/json",
      "Accept": "application/json"
    },
    body: JSON.stringify({ username, password }),
    mode: 'cors',
    cache: 'no-cache'
  })
  .then(response => {
    console.log('Resposta do servidor:', response.status, response.statusText);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Dados recebidos:', data);
    if (data.success) {
      document.getElementById("login-container").classList.add("hidden");
      document.getElementById("admin-container").classList.remove("hidden");
      loadMatches();
      showAlert("Login realizado com sucesso!", "success");
    } else {
      showAlert("Usuário ou senha incorretos!");
    }
  })
  .catch((error) => {
    console.error('Erro completo:', error);
    let errorMessage = "Erro ao conectar no servidor.";
    
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      errorMessage += " Verifique se o servidor está rodando em " + API;
    } else if (error.message.includes('HTTP 404')) {
      errorMessage += " Endpoint de login não encontrado.";
    } else if (error.message.includes('HTTP 500')) {
      errorMessage += " Erro interno do servidor.";
    } else {
      errorMessage += " " + error.message;
    }
    
    showAlert(errorMessage);
  })
  .finally(() => {
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

function updateStats(data) {
  const totalMatches = Object.values(data).reduce((sum, round) => sum + round.length, 0);
  
  document.getElementById('total-matches').textContent = totalMatches;
  document.getElementById('oitavas-count').textContent = data.oitavas?.length || 0;
  document.getElementById('quartas-count').textContent = data.quartas?.length || 0;
  document.getElementById('semifinais-count').textContent = data.semifinais?.length || 0;
}

function loadMatches() {
  fetch(API + "/api/matches")
    .then(res => res.json())
    .then(data => {
      updateStats(data);
      
      const container = document.getElementById("matches-list");
      container.innerHTML = "";
      
      let hasMatches = false;
      
      for (const round in data) {
        if (data[round] && data[round].length > 0) {
          hasMatches = true;
          data[round].forEach(match => {
            const div = document.createElement("div");
            div.className = "match-item";
            div.innerHTML = `
              <div class="match-round">${getRoundName(round)}</div>
              <div class="match-teams">
                <div class="team-name">${match.teamA.name}</div>
                <div class="match-score">${match.scoreA ?? '-'} x ${match.scoreB ?? '-'}</div>
                <div class="team-name">${match.teamB.name}</div>
              </div>
              <div class="match-actions">
                <button class="btn btn-danger btn-small" onclick="deleteMatch(${match.id})" title="Excluir partida">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            `;
            container.appendChild(div);
          });
        }
      }
      
      if (!hasMatches) {
        container.innerHTML = `
          <div style="text-align: center; color: var(--text-muted); padding: 2rem;">
            <i class="fas fa-inbox fa-2x"></i>
            <p style="margin-top: 1rem;">Nenhuma partida registrada ainda.</p>
          </div>
        `;
      }
    })
    .catch(error => {
      console.error('Erro ao carregar partidas:', error);
      showAlert("Erro ao carregar partidas.");
    });
}

function getRoundName(round) {
  const names = {
    'oitavas': 'Oitavas de Final',
    'quartas': 'Quartas de Final',
    'semifinais': 'Semifinais',
    'final': 'Final'
  };
  return names[round] || round;
}

function addMatch() {
  const round = document.getElementById("round").value;
  const teamA = { 
    name: document.getElementById("teamA").value.trim(), 
    logo: document.getElementById("logoA").value.trim() || "default_logo.png"
  };
  const teamB = { 
    name: document.getElementById("teamB").value.trim(), 
    logo: document.getElementById("logoB").value.trim() || "default_logo.png"
  };
  const scoreA = document.getElementById("scoreA").value;
  const scoreB = document.getElementById("scoreB").value;

  if (!teamA.name || !teamB.name) {
    showAlert("Por favor, preencha os nomes dos times.");
    return;
  }

  const btn = document.querySelector('.btn-success');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<div class="loading"></div> Adicionando...';
  btn.disabled = true;

  fetch(API + "/api/add-match", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ round, teamA, teamB, scoreA, scoreB })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      loadMatches();
      clearForm();
      showAlert("Partida adicionada com sucesso!", "success");
    } else {
      showAlert(data.message || "Erro ao adicionar partida.");
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    showAlert("Erro ao adicionar partida.");
  })
  .finally(() => {
    btn.innerHTML = originalText;
    btn.disabled = false;
  });
}

function deleteMatch(matchId) {
  if (!confirm('Tem certeza que deseja excluir esta partida?')) {
    return;
  }

  fetch(API + `/api/delete-match/${matchId}`, {
    method: "DELETE"
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      loadMatches();
      showAlert("Partida excluída com sucesso!", "success");
    } else {
      showAlert(data.message || "Erro ao excluir partida.");
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    showAlert("Erro ao excluir partida.");
  });
}

function clearForm() {
  document.getElementById("teamA").value = "";
  document.getElementById("teamB").value = "";
  document.getElementById("logoA").value = "";
  document.getElementById("logoB").value = "";
  document.getElementById("scoreA").value = "";
  document.getElementById("scoreB").value = "";
}

function logout() {
  document.getElementById("admin-container").classList.add("hidden");
  document.getElementById("login-container").classList.remove("hidden");
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  clearForm();
}

// Permitir login com Enter
document.getElementById("password").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    login();
  }
});

document.getElementById("username").addEventListener("keypress", function(event) {
  if (event.key === "Enter") {
    document.getElementById("password").focus();
  }
});
</script>

</body>
</html>